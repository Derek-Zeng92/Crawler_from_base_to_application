TY.namespace("m"),TY.loadedModule("TY.m.bbsPost"),TY.m.bbsPost=function(e){function a(){TY.loader("TY.m.shareV2",function(){new TY.m.shareV2.share({position:"#shareWrap",show:!0,via:["weixin","qzone","tsina","douban"],title:c.title,summary:c.desc,linkShow:!0,img:c.img,header:"分享好贴",renderCbk:function(){$("#shareWrap .loading").remove(),$("#shareWrap").delegate("a","click",function(){var e=$(this);s("分享-"+(e.attr("class")||"复制"))})},goWxBackCbk:function(){}})})}function t(e,a,t,i){$('<div id="j-msg" class="u-msg"><p></p></div>').appendTo("body").addClass("u-msg-"+e).show().find("p").html("<i></i>"+a);setTimeout(function(){$("#j-msg").remove(),i&&i()},t||2e3)}function i(){return TY.os&&TY.os.ios?parseInt(window.scrollY,10):Math.max(document.documentElement.scrollTop,document.body.scrollTop)||0}function n(e){window.scrollTo(0,e)}function o(e){if(!__global.isOnline()){var a=window.location.href;return s(e+"-未登录"),window.location.href="//passport.tianya.cn/login_m.jsp?fowardURL="+encodeURIComponent(a)+"&fowardFlag=y",!1}return!0}function s(e){var a="m-v3-",t="",i=location.host+location.pathname,n={index:/^www.tianya.cn\/m\/$/,bbs:/^bbs.tianya.cn\/m\/$/,other:/\/m\/(\w+)/},o=window.navigator.userAgent.toLowerCase(),s="micromessenger"==o.match(/MicroMessenger/i)?!0:!1,r=[];for(var d in n)r=i.match(n[d]),r&&(t=d),"other"==d&&r&&(t=r[1]);"undefined"!=typeof _hmt&&e?_hmt.push(["_trackEvent",a+t+"-"+e+(s?"-wx":""),"click"]):"undefined"==typeof _hmt&&setTimeout(function(){"undefined"!=typeof _hmt&&_hmt.push(["_trackEvent",a+t+"-"+e+(s?"-wx":""),"click"])},1e3)}function r(e,a,t,i,n){function o(){var e=$("body").height(),a=document.documentElement.clientHeight;r.height(a>e?a:e),t&&t(!0),r.show()}function s(e){r.hide(),t&&t(!1,e)}var r=$("#"+e);if(!r.size()){var d='<div class="func-mask '+(i||"")+'" id="'+e+'"></div>';TY("body").append(d),r=TY("#"+e)}r.unbind("click").bind("click",function(e){return s(e),!1}),n||r.bind("touchmove",function(){return!1}),this.hide=function(){s()},this.show=function(){o()}}function d(e){function d(e){A?e&&e(A):$.loader("TY.m.shangImg",function(a){A=new a,e&&e(A)})}function c(e){e=e||"回复",Y.show(),z=i(),moreDiv.hide(),B=!1;var a=$(window).height(),t=Y.position().top-(N?a-50:110),n="func-edit-off";Y.addClass(cls);var o=Y.get(0);o.style.top=t+"px",mask.show(),R=!0,T.editPermission||T.isRemark?(W.removeAttr("readonly"),Y.removeClass(n)):(W.attr({readonly:!0}),Y.addClass(n)),T.isRemark&&T.replyId?(O.show(),M.init(),P.hide()):(P.show(),$("#proxy").size()||$("body").append('<iframe src="//photo.tianya.cn/js/touchProxy.html" name="proxy" id="proxy" style="display:none;"></iframe>'),d(),O.hide()),F?setTimeout(function(){m()},0):m(),T.isShowFix||Y.show(),s(e+"框展开")}function l(){var e=Y.get(0);e.style.top="auto",e.style.bottom="0px",e.style.height="auto",Y.removeClass(cls),moreDiv.hide(),z&&(n(z),z=0),R=!1,B=!1;var a=W.val(),t=W.attr("placeholder");(""==a||a==t)&&W.attr({placeholder:"一起来吐槽"}).val(""),T.el&&T.el.removeClass(bgCls),$(".control-vcode").hide(),T.isShowFix||Y.hide()}function m(){var e=W.val().length,a=W.get(0);a.setSelectionRange(e,e),a.focus()}function p(e,a,t,i,n){i=$.isString(i)?i:i.html(),i=i.replace(/<br\/?>/g,"\n"),n=n||200;var o=$("<div>"+i+"</div>"),s=[],r=[],d="",c=[];o.each(function(){var e="";"string"==typeof this?(e=$.trim(this),e&&s.push("    "+e)):"BR"===$(this).prop("tagName")||"STYLE"===$(this).prop("tagName")?s.push("\n"):"IMG"===$(this).prop("tagName")?s.push("\n    "+$(this).attr("src")+"\n"):(e=$.trim($(this).text()),e&&s.push("    "+e))}),c=s.join("").match(/(.|\n)*\-{15,}/g),r.push(c?c+"\n":""),e&&r.push("    @"+e+" "+d+a+"\n");var l=s.join("").replace(/(.|\n)*\-{15,}/g,""),m=function(e,a){var t=e.match(/https?:\/\/[a-zA-Z0-9]+(\.[a-zA-Z0-9]+)+([-_A-Z0-9a-z\$\.\+\!\*\/,:;@&=\?\~\#\%]*)*/gi)||[],i=!0;return $.each(t,function(t,n){for(var o=e.split(n),s=0,r=n.getCNlen(),d="",c=0;c<o.length;c++){if(s+=o[c].getCNlen(),d+=o[c],d+=n,a>s&&s+r>a)return e=d+"......",i=!1,!0;s+=r}}),i&&(e=e.subStringCn(a,!0)+"...."),e},p=l.getCNlen();p>n&&(l=m(l,n)),r.push(l),r.push("\n    -----------------------------\n");var u=r.join("");return u=u.replace(/\n+/g,"\n"),e&&r.push("    @"+e+" "+d+a+"\n"),u}function u(){$("#vcode").html('<input type="text" placeholder="验证码" maxlength="4" size="4" name="pose-title" id="pose_vcode" required />					<img width="80" src="//imgcode.tianya.cn/services/ImageCodeService" height="32" alt="验证码" id="imgCode"/>');var e=function(){var e="//imgcode.tianya.cn/services/ImageCodeService?_r="+(new Date).getTime();$("#imgCode").attr("src",e),$("#pose-vcode").val("")};e(),$("#imgCode").bind("click",function(){e()}),codeDiv.show()}function h(e){function a(){var e=W.val();return e.length}function t(){var t=e-a();0>t?i.addClass("fc-red"):i.removeClass("fc-red"),i.html(t)}e=e||140;var i=$(".u-reply-long strong");W.bind("keyup keydown blur",function(){t()}),this.init=function(){t()},this.remainNum=function(){return e-a()}}function f(){var e=location.host;return"bbs.hainan.net"==e||"bbs.tianya.cn"==e?!1:document.domain}function v(e,a,t){var i=f();if(e=i&&-1==e.indexOf("//")?"//bbs."+i+e:e,i){var n=T.fromCms?"//content."+i+"/proxy-tianya.html":"//bbs."+i+"/m/proxy.html";new TY.util.proxy({name:"tianyacnProxy",path:n,time:15},"ajax",{url:e,data:a,dataType:"html",cache:!1,success:function(e){t(e)},type:"POST"})}else $.post(e,a,function(e){t(e)})}function g(e){function a(e){e=$.parseJSON(e),e&&"true"==e.status?(t("success","发表成功！"),x(n.content.TY_html()),_(!0,n.content.TY_html(),e)):(t("error",e&&e.msg||"发表失败！"),_(!1))}var i="//content.tianya.cn/comment/ForumCommentDoNew.jsp",n={articleid:T.articleId,sectionId:T.sectionId,replyType:"2",anonymousId:"0",content:e,userId:userId,userName:userName,comeFrom:"0",item:T.item,postId:T.artId,subItem:"",orgContent:p(null,null,null,T.article,600),curHref:location.href};v(i,n,a)}function b(e){function a(a){a=JSON.parse(a),a&&"1"==a.success?(t("success",a.message),T.wendaInitContent=e,k(T.replyId,a.data.content),_(!0,a.data.content,a)):(t("error",a&&a.message||"操作失败"),_(!1))}var i="/api?method=bbs.api.updateWenDaReplyContent",n={"params.item":T.item,"params.artId":T.artId,"params.replyId":T.replyId,"params.content":e};v(i,n,a)}function y(e,a){function i(a){var i=$.parseJSON(a);if("1"==i.success){if("true"==i.data.msg)return t("success","发表成功！"),x(i.data&&i.data.content||o["params[content]"].TY_html(),i.data.replyId,i.data.time),o["params[replyId]"]=i.data.replyId,$.post("//bbs.tianya.cn/api?method=bbs.api.qingPost",o,function(){}),T.isWenda&&(T.wendaInitContent=e,T.replyId=i.data.replyId),void _(!0,i.data&&i.data.content||o["params[content]"].TY_html(),i);if(i.data.error_code)switch(i.data.error_code){case"-111":t("info","本版只允许成员才能发帖，请先申请加入");break;case"110":t("error","发帖失败，系统怀疑您的账号有非人为发帖等异常行为。");break;case"112":/验证码\[\]/.test(i.data.message)?u():t("error",i.data.message);break;case"-15":t("error","您的账号未激活，将为您跳去激活页面。",4e3,function(){location.href="//passport.tianya.cn/m/identity/mobile.do"});break;default:t("error",i.data.message||"发表失败！")}}else t("error",i.message);_(!1),s("提交回复")}if(T.fromCms)return void g(e);if(!T.isRemark&&T.isWenda&&T.wendaInitContent)return void b(e);var n="/api?method=bbs.ice.reply",o={"params[appId]":"touch","params[bScore]":!0,"params[bWeiBo]":!1,"params[userId]":userId,"params[item]":T.item,"params[artId]":T.artId,"params[action]":"","params[content]":e};a&&a.length&&(o["params[vCode]"]=a),v(n,o,i)}function w(e){function a(a){var i=$.parseJSON(a);return"1"==i.success?(t("success",i.data.message),I(n),void _(!0,e,i)):(i&&i.message&&-1!=i.message.indexOf("ID尚未激活")?t("error","您的账号未激活，将为您跳去激活页面。",4e3,function(){location.href="//passport.tianya.cn/m/identity/mobile.do"}):t("info",i&&i.message||"评论失败"),_(!1),void s("提交评论"))}var i="/api?method=bbs.api.comment",n={"params.item":T.item,"params.artId":T.artId,"params.replyId":T.replyId,"params.comefrom":0,"params.bFilterHtml":!0,"params.content":e};v(i,n,a)}function I(e){var a=['<li class="">','<span data-id="'+userId+'" class="author fc-blue">'+userName+"</span>:    ",'<span class="cnt">'+e["params.content"].TY_html()+"</span>",'<span class="time fc-gray">刚刚</span>'," </li>"].join(""),t=['<div class="comments u-arrow" data-total="1">','<ul class="u-list-comment">',a,"</ul>","</div>"].join(""),i=T.el.closest(".item"),n=i.find(".u-list-comment");n.size()?n.append(a):i.find(".bd").append(t)}function x(e,a,t){e="<p>"+e.replace("　　","")+"</p>";var i=['<div class="item item-ht" data-replyid="'+(a||0)+'">','<div class="hd f-cf">','<a class="info" href="//www.tianya.cn/m/home.jsp?uid='+userId+'">','<h4 class="author" data-id="">'+userName+"</h4>",'<p class="time fc-gray">'+(t||"刚刚")+"</p>",'<span class="floor fc-gray"></span></a>',"</div>",'<div class="bd reply-new-bd"><div class="reply-div">',e,"</div></div>","</div>"].join("");$("#j-post-content .content").append(i);var n=$(".reply-new-bd ."+E);n.size()&&d(function(){A.initShangImg(n)})}function k(e,a){a="<p>"+a.replace("　　","")+"</p>",$(".item[data-replyid='"+e+"'] .reply-div").html(a)}function C(e){var a=W.val(),i=$("#pose_vcode");if(code="",a.length){if(e&&(code=i.val().trim(),!code.length))return t("error","请输入验证码"),!1;if(loadingDiv.show(),T.isRemark&&T.replyId){if(M.remainNum()<0)return t("error","评论字数超了，精简一下吧。"),loadingDiv.hide(),!1;w(a,code)}else d(function(){a=A.checkReplyShangImg(a),y(a,code)})}else W.get(0).focus()}function _(e,a,t){e&&(mask.hide(!0),T.postCbk(T.replyId?"remark":"reply",!0,a,t),W.val("").attr({placeholder:T.placeholder}),$("#preview").html(""),$(".control-vcode").hide()),loadingDiv.hide()}function S(){function e(e){e=JSON.parse(e),e&&1==e.success&&0==e.code&&(T.editPermission="true"==e.data.permission?!0:!1,T.wendaInitContent=T.editPermission?e.data.content:"您的回答被删除，如有疑问请联系版主或管理员",T.replyId=e.data.id,txtHolder.html(T.placeholder2||T.placeholder))}var a="//bbs.tianya.cn/api?method=bbs.api.getWendaReply",t={"params.item":T.item,"params.artId":T.artId};v(a,t,e)}var T={item:0,artId:0,replyId:0,isRemark:!1,isWenda:!1,placeholder:"一起来拍砖",placeholder2:"",editPermission:!0,isShowFix:!0,isShangImg:!1,isBottomRightIcon:!1,maxWidth:0,article:$("article").html(),postCbk:function(){},renderCbk:function(){}};"undefined"!=typeof bbsGlobal&&$.extend(T,bbsGlobal),$.extend(T,e),T.isWenda&&(T.isShangImg=!1);var N=TY.mobile.isMobile()&&TY.mobile.browser.isAndroid?!0:!1;$("body").append(['<div class="u-func f-cf" id="edit_div" style="display:'+(T.isShowFix?"":"none")+";"+(T.maxWidth?"max-width:"+T.maxWidth+"px":"")+'">','<div class="func-wrap '+(T.isBottomRightIcon?"right-2icon":"")+' f-cf" >','<form  class="text-form"><span class="txt-holder" placeholder="'+T.placeholder+'">'+T.placeholder+'</span><textarea class="eidt-txt"  id="textAreaContainer" ></textarea></form>','<div class="tools f-cf">','<div id="upload" class="pose-upload">','<s class="icon-img"></s>','<s class="icon-ds-img" style="display:'+(T.isShangImg?"":"none;")+'"></s>','<form name="upload-from" id="upload-from" action="" method="POST" enctype="multipart/form-data">','<input type="file" name="file" class="upload-input" id="file" accept="image/*"/>','<input type="file" name="ds-file" class="upload-ds-input" id="ds-file" accept="image/*" style="display:'+(T.isShangImg?"":"none;")+'"/>',"</form>","</div>",'<div class="u-reply-long fc-gray f-fl">还可以输入<strong>136</strong>字</div>','<div class="pose-send">','<i class="cancle" id="cancel_send_btn">取消</i>','<i class="send" id="send_btn">发送</i>',"</div>","</div>",'<div class="control-vcode">',"<p>涯叔说，新人要欺负下，请输入验证码后再提交。</p>",'<div class="code-wrap" id="vcode"></div>','<div class="submit"><a href="#" id="code_cancle" >取消</a> <a href="#" id="code_submit" >提交</a></div>',"</div>",'<div class="upload-preview f-cf" id="preview"></div>','<div class="loading" id="post_loading"><em><i class="three-quarters-loader"></i>提交中...</em></div>',"</div>",'<span class="more-icon"></span>',T.isBottomRightIcon?'<span class="more-icon-2"></span>':"",'<div class="more-func"><div class="more-wrap">','<div class="u-faxian f-cf">',"</div>",'<div class="u-share">','<div class="share-zone" id="shareWrap">','<div class="loading" ><em><i class="three-quarters-loader"></i>请稍候...</em></div>',"</div>","</div>","</div></div>","</div>"].join(""));{var Y=$("#edit_div"),W=Y.find("textarea"),R=!1;$()}mask=new r("func_mask",Y,function(e){e||l()},"color-mask",!0),cls="active-func",bgCls="edit-bg",txtForm=Y.find(".text-form"),txtHolder=Y.find(".txt-holder"),moreBtn=Y.find(".more-icon"),moreDiv=Y.find(".more-func"),codeDiv=Y.find(".control-vcode"),loadingDiv=Y.find(".loading"),userId=__global.getUserId(),userName=__global.getUserName();var D=navigator.userAgent.toLowerCase(),j=/sogou|dolphin|liebao/,F=N&&(D.match(j)||function(){return D.match(/vivo|huawei/)&&!D.match(/baidu|chrome|uc|qq/)?!0:!1}());txtForm.bind("click",function(){if(!o("回复"))return!1;if(!R){var e=W.val(),a=W.attr("placeholder");W.get(0).focus(),T.isRemark=!1,T.isWenda?(W.attr({placeholder:"回答楼主"}),T.wendaInitContent&&W.val(T.wendaInitContent)):(""==W.val()||e==a)&&(T.replyId=0,W.attr({placeholder:"回复:"}),W.val("")),c()}return!1});var G=!1,B=!1;moreBtn.bind("click",function(){return G||(G=!0,a()),B=!B,B?(moreDiv.show(),moreDiv.find(".u-faxian").show(),R||mask.show(),s("展开更多")):mask.hide(),!1}),txtForm.bind("touchmove",function(){}),$("#cancel_send_btn").click(function(){mask.hide()});var O=Y.find(".u-reply-long"),P=Y.find(".pose-upload"),z=0,A=null,E="js-dashang-pic",q=$("."+E);T.isShangImg&&q.size()&&d(function(){A.initShangImg(q)}),T.isShowFix&&$("body").css({paddingBottom:"30px"});var L={add:function(){var e=$("#upload .icon-img"),a=document.domain,i="icon-loading";$("#file").change(function(){if(e.hasClass(i))return!1;e.addClass(i);var n;if(n=window.bbsGlobal&&bbsGlobal.isWeiLun&&bbsGlobal.isSealItem&&"true"===bbsGlobal.isWeiLun&&"true"===bbsGlobal.isSealItem?"//photo."+a+"/photo?act=uploadphoto&watermark=1&app=weilun":"//photo."+a+"/photo?act=uploadphoto&watermark=1&app=bbs",__global.isOnline()){var r=document.getElementById("proxy").contentWindow,d=document.getElementById("file").files[0],c=new FormData,l=new r.XMLHttpRequest;c.append("file",d),l.open("POST",n,!0),l.send(c),l.onload=function(){if(e.removeClass(i),200==this.status){var a=/<body>(.*?)<\/body>/.exec(this.responseText),n=a[1];n=$.parseJSON(n),1==n.result?(W.val(W.val()+"\n"+n.data.photo[0].mediumurl.replace("http://","https://")+"\n"),$("#preview").append('<i><img src="'+n.data.photo[0].mediumurl.replace("http://","//")+'"></i>'),m()):t("error",n.error)}else t("error","上传失败,请重试")}}else o("上传图片");s("上传图片")})},remove:function(){$("#preview").delegate("i","click",function(){var e=$(this),a=e.find("img").attr("src");e.remove(),$("#textAreaContainer").val($("#textAreaContainer").val().replace(a,""))})},init:function(){L.add(),L.remove()}};L.init(),$("#send_btn").bind("click",function(){C(0)}),$("#code_submit").bind("click",function(){C(1)}),$("#code_cancle").bind("click",function(){codeDiv.hide()}),Y.delegate(".u-faxian a","click",function(){return l(),mask.hide(!0),!1}),T.isWenda&&S(),this.showEdit=function(e){T.replyId=e.replyId||0;var a="回复";if(T.replyId)T.isRemark=!0,a=e.name?"评论 "+e.name+"：":"",W.val(a).attr({placeholder:a}),a="评论";else if(e.txt&&""!=e.txt){W.val(p(e.name,e.time,e.floor,e.txt));try{m()}catch(t){}$("#preview").html(""),W.attr({placeholder:W.val()}),a="@TA"}else T.isRemark=!1,W.val(""),$("#preview").html(""),W.attr({placeholder:T.placeholder});T.el=e.el,T.el&&T.el.addClass(bgCls),c(a),F||m()},this.hideFixBanner=function(){T.isShowFix=!1,Y.hide()},this.showShare=function(){moreBtn.trigger("click"),moreDiv.find(".u-faxian").hide()};var M=null;M=new h,T.renderCbk()}var c={appId:"wx5c6e44709626575e",link:"undefined"!=typeof bbsGlobal?"//bbs.tianya.cn/m/post-"+bbsGlobal.item+"-"+bbsGlobal.artId+"-1.shtml":location.origin+location.pathname,title:document.title,desc:"undefined"!=typeof bbsGlobal?"文/"+bbsGlobal.authorName+";发表于"+bbsGlobal.itemName:"",img:"//static.tianyaui.com/global/m/v3/static/images/logo-ty.png"},l=new d(e);this.showEdit=function(e){var a=e.replyId?!1:!0;l.showEdit(e,a)},this.showShare=function(){l.showShare()}};